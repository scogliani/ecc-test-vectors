#include <openssl/err.h>

#include <ecc.h>
#include <ecc_pointmul.h>
#include <utils.h>

void ecc_coord_init(Ecc_coord *ecc_coord)
{
  if (!(ecc_coord->x = BN_new()))
  {
    goto err;
  }

  if (!(ecc_coord->y = BN_new()))
  {
    goto err;
  }

  return;

err:
  ERR_print_errors_fp(stderr);

  ecc_coord_destroy(ecc_coord);
}

void ecc_coord_destroy(Ecc_coord *ecc_coord)
{
  if (ecc_coord->x)
  {
    BN_free(ecc_coord->x);
  }

  if (ecc_coord->y)
  {
    BN_free(ecc_coord->y);
  }
}

void ecc_pointmul(Ecc_coord *ecc_coord, EC_GROUP *group, const char *m)
{
  BN_CTX *ctx = NULL;
  BIGNUM *mul = NULL;
  EC_POINT *point = NULL;

  if (!(mul = BN_new()))
  {
    goto err;
  }

  if (!(ctx = BN_CTX_new()))
  {
    goto err;
  }

  if (!(point = EC_POINT_new(group)))
  {
    goto err;
  }

  if (!BN_dec2bn(&mul, m))
  {
    goto err;
  }

  if (!EC_GROUP_precompute_mult(group, ctx))
  {
    ABORT;
  }

  if (!EC_POINT_mul(group, point, mul, NULL, NULL, ctx))
  {
    ABORT;
  }

  if (EC_POINT_is_at_infinity(group, point))
  {
    ABORT;
  }

  if (!EC_POINT_get_affine_coordinates_GFp(group, point, ecc_coord->x,
                                           ecc_coord->y, ctx))
  {
    ABORT;
  }

err:
  ERR_print_errors_fp(stderr);

  if (point)
  {
    EC_POINT_free(point);
  }

  if (mul)
  {
    BN_free(mul);
  }

  if (ctx)
  {
    BN_CTX_free(ctx);
  }
}

void ecc_coord_k_values(const char *array[ECC_POINTMUL_TEST_VECTOR_SIZE],
                        EC_GROUP const *group)
{
  if (group == secp192r1)
  {
    array[0] = "1";
    array[1] = "2";
    array[2] = "3";
    array[3] = "4";
    array[4] = "5";
    array[5] = "6";
    array[6] = "7";
    array[7] = "8";
    array[8] = "9";
    array[9] = "10";
    array[10] = "11";
    array[11] = "12";
    array[12] = "13";
    array[13] = "14";
    array[14] = "15";
    array[15] = "16";
    array[16] = "17";
    array[17] = "18";
    array[18] = "19";
    array[19] = "20";
    array[20] = "112233445566778899";
    array[21] = "112233445566778899112233445566778899";
    array[22] = "1618292094200346491064154703205151664562462359653015613567";
    array[23] = "1484605055214526729816930749766694384906446681761906688";
    array[24] = "1569275434166462877105627261392580354519833538813866540831";
    array[25] = "3138550867681922400546388175470823984762234518836963313664";
    array[26] = "3138550119404545973088374812479323842475901485681169401600";
    array[27] = "24519928471166604179655321383971467003990211439919824896";
    array[28] = "46756768218837031708063422466358611246556475572231";
    array[29] = "3138502977207688322901699644928655553044791844086883549215";
    array[30] = "47890485652059026491391979477371914515865621847605503";
    array[31] = "3138549376958826959341570842566593375326996431013993775615";
    array[32] = "6277101735386680763835789423176059013767194773182842284061";
    array[33] = "6277101735386680763835789423176059013767194773182842284062";
    array[34] = "6277101735386680763835789423176059013767194773182842284063";
    array[35] = "6277101735386680763835789423176059013767194773182842284064";
    array[36] = "6277101735386680763835789423176059013767194773182842284065";
    array[37] = "6277101735386680763835789423176059013767194773182842284066";
    array[38] = "6277101735386680763835789423176059013767194773182842284067";
    array[39] = "6277101735386680763835789423176059013767194773182842284068";
    array[40] = "6277101735386680763835789423176059013767194773182842284069";
    array[41] = "6277101735386680763835789423176059013767194773182842284070";
    array[42] = "6277101735386680763835789423176059013767194773182842284071";
    array[43] = "6277101735386680763835789423176059013767194773182842284072";
    array[44] = "6277101735386680763835789423176059013767194773182842284073";
    array[45] = "6277101735386680763835789423176059013767194773182842284074";
    array[46] = "6277101735386680763835789423176059013767194773182842284075";
    array[47] = "6277101735386680763835789423176059013767194773182842284076";
    array[48] = "6277101735386680763835789423176059013767194773182842284077";
    array[49] = "6277101735386680763835789423176059013767194773182842284078";
    array[50] = "6277101735386680763835789423176059013767194773182842284079";
    array[51] = "6277101735386680763835789423176059013767194773182842284080";
    return;
  }
  if (group == secp224r1)
  {
    array[0] = "1";
    array[1] = "2";
    array[2] = "3";
    array[3] = "4";
    array[4] = "5";
    array[5] = "6";
    array[6] = "7";
    array[7] = "8";
    array[8] = "9";
    array[9] = "10";
    array[10] = "11";
    array[11] = "12";
    array[12] = "13";
    array[13] = "14";
    array[14] = "15";
    array[15] = "16";
    array[16] = "17";
    array[17] = "18";
    array[18] = "19";
    array[19] = "20";
    array[20] = "112233445566778899";
    array[21] = "112233445566778899112233445566778899";
    array[22] =
        "695051161996583945098890068815071277801573798394069196805190031968"
        "0";
    array[23] =
        "134799729334100603270357890205094316950949024354942953385706021194"
        "23";
    array[24] =
        "134799717517456825813514553113142080938986072294297406183903907020"
        "79";
    array[25] =
        "134799729318653281064869715463244653929529759803432281609627028684"
        "79";
    array[26] =
        "117957737088349160264041424341510655069316073415233881402254432655"
        "36";
    array[27] = "784254593043826236572847595991346435467177662189391577090";
    array[28] =
        "134797676455056547466238877977833878535761741934806958264428580126"
        "71";
    array[29] =
        "205688069665150753842126177372015544874550518966168735589597183";
    array[30] =
        "134799669309193377288951684620906832491597029771138233846182821232"
        "95";
    array[31] = "50210731791415612487756441341851895584393717453129007497216";
    array[32] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "41";
    array[33] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "42";
    array[34] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "43";
    array[35] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "44";
    array[36] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "45";
    array[37] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "46";
    array[38] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "47";
    array[39] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "48";
    array[40] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "49";
    array[41] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "50";
    array[42] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "51";
    array[43] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "52";
    array[44] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "53";
    array[45] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "54";
    array[46] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "55";
    array[47] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "56";
    array[48] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "57";
    array[49] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "58";
    array[50] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "59";
    array[51] =
        "269599466671506397946670150870196259404578077144243917216827223680"
        "60";
    return;
  }
  if (group == secp256r1 || group == frp256v1)
  {
    array[0] = "1";
    array[1] = "2";
    array[2] = "3";
    array[3] = "4";
    array[4] = "5";
    array[5] = "6";
    array[6] = "7";
    array[7] = "8";
    array[8] = "9";
    array[9] = "10";
    array[10] = "11";
    array[11] = "12";
    array[12] = "13";
    array[13] = "14";
    array[14] = "15";
    array[15] = "16";
    array[16] = "17";
    array[17] = "18";
    array[18] = "19";
    array[19] = "20";
    array[20] = "112233445566778899";
    array[21] = "112233445566778899112233445566778899";
    array[22] =
        "298522200982212610791839233145992061006669024143302452063927887036"
        "77545185283";
    array[23] =
        "578960428999613948620057784646438823899784495767587480737259834899"
        "54366354431";
    array[24] =
        "176684539294571015150188910572904988299766000482484891595541966036"
        "6636031";
    array[25] =
        "289480257603075345177347916878947758044660726152429634430976613556"
        "06862201087";
    array[26] =
        "113078210460870548944811695960290644973229224625838436424477095834"
        "645696384";
    array[27] =
        "120780561068834881612429832860513411250857614706779067219174792689"
        "09056";
    array[28] =
        "577829698573854480823199578603286529985407609982939760837188044507"
        "08503920639";
    array[29] =
        "578960171194600467595836627570901003414359437677777079064555511632"
        "57755533312";
    array[30] =
        "452312848374287284681282171017647412726433684238464212999305864837"
        "160993279";
    array[31] =
        "904571339174065134293634407946054000774746055866917729876676367558"
        "469746684";
    array[32] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044349";
    array[33] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044350";
    array[34] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044351";
    array[35] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044352";
    array[36] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044353";
    array[37] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044354";
    array[38] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044355";
    array[39] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044356";
    array[40] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044357";
    array[41] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044358";
    array[42] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044359";
    array[43] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044360";
    array[44] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044361";
    array[45] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044362";
    array[46] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044363";
    array[47] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044364";
    array[48] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044365";
    array[49] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044366";
    array[50] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044367";
    array[51] =
        "115792089210356248762697446949407573529996955224135760342422259061"
        "068512044368";
    return;
  }
  if (group == secp384r1)
  {
    array[0] = "1";
    array[1] = "2";
    array[2] = "3";
    array[3] = "4";
    array[4] = "5";
    array[5] = "6";
    array[6] = "7";
    array[7] = "8";
    array[8] = "9";
    array[9] = "10";
    array[10] = "11";
    array[11] = "12";
    array[12] = "13";
    array[13] = "14";
    array[14] = "15";
    array[15] = "16";
    array[16] = "17";
    array[17] = "18";
    array[18] = "19";
    array[19] = "20";
    array[20] = "112233445566778899";
    array[21] = "112233445566778899112233445566778899";
    array[22] =
        "101581841128675408197547767558197617567245229485404199796378684359"
        "24061464745859402573149498125806098880003248619520";
    array[23] =
        "985050155110599102824505260505699213981009490891279925411584768388"
        "1357749738726091734403950439157209401153690566655";
    array[24] =
        "985050272340574709731727119476331048246275145518569963057166165794"
        "6308788426092983270628740691202018691293898608608";
    array[25] =
        "114618937181783299094761140045088940607021573525537028081173658784"
        "5016396640969656447803207438173695115264";
    array[26] =
        "961934143821709764186539029718970885893801798642615262263950017977"
        "4624579127744608993294698873437325090751520764";
    array[27] =
        "123130799662383374238740035238017256607792741513681328273564191839"
        "5585376659282194317590461518639141730493780722175";
    array[28] =
        "587118838854683800942906722504810343086699021451906946003274128973"
        "058942197377013128840514404789143516741631";
    array[29] =
        "153914077530671739663795070876894766451466019374644150541452557147"
        "890542143280855693795882295846834387672681660416";
    array[30] =
        "751487846061351504762681718500821762568567767505605394661965043905"
        "87921789283134009866871754361028131485122560";
    array[31] =
        "196913837613101936650952924247548077456867990298147078492733815140"
        "21788371252213000473497648851202400395528761229312";
    array[32] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942623";
    array[33] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942624";
    array[34] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942625";
    array[35] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942626";
    array[36] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942627";
    array[37] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942628";
    array[38] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942629";
    array[39] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942630";
    array[40] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942631";
    array[41] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942632";
    array[42] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942633";
    array[43] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942634";
    array[44] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942635";
    array[45] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942636";
    array[46] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942637";
    array[47] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942638";
    array[48] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942639";
    array[49] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942640";
    array[50] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942641";
    array[51] =
        "394020061963944792122790401001436138050797392704654466679469052796"
        "27659399113263569398956308152294913554433653942642";
    return;
  }
  if (group == secp521r1)
  {
    array[0] = "1";
    array[1] = "2";
    array[2] = "3";
    array[3] = "4";
    array[4] = "5";
    array[5] = "6";
    array[6] = "7";
    array[7] = "8";
    array[8] = "9";
    array[9] = "10";
    array[10] = "11";
    array[11] = "12";
    array[12] = "13";
    array[13] = "14";
    array[14] = "15";
    array[15] = "16";
    array[16] = "17";
    array[17] = "18";
    array[18] = "19";
    array[19] = "20";
    array[20] = "112233445566778899";
    array[21] = "112233445566778899112233445566778899";
    array[22] =
        "176980527797516303525377593084236712909374178672537678600734933265"
        "332381265665829141343503325767757909536663252144885414127592614418"
        "7294499863933403633025023";
    array[23] =
        "104748400337157462316262627929132596317243790506798133267698218707"
        "528750292682889221414310155907963824712114916552440160880550666043"
        "997030661040721887239";
    array[24] =
        "670390386507834588814138165143016803949666407735096505428813312654"
        "930705874178867114819742977734393646612757593803178614740947262747"
        "9702469884214509568000";
    array[25] =
        "167592564368239530540451716564356225188002695878089653169885673702"
        "417988034333987833638241205026343194297493964668348090643463296347"
        "8257639757341102436352";
    array[26] =
        "127851333821494152214024952025867017986206961694467725990382357218"
        "623386921901561639515589638569590592323816028647439244274517867695"
        "15154396810706943";
    array[27] =
        "214524875832249255872206855495734426889477529336261655255492425273"
        "322727861341825677722947375406711676372335314043071600934941615185"
        "418540320233184489636351";
    array[28] =
        "511404862755678591311390778908355268846484618578230883486511538405"
        "082876213668545068312447465312722466202951231042695658670559493782"
        "66395604768784399";
    array[29] =
        "665152971602520688103527995288152062784115224721278452091442503931"
        "260612019887908083964331134716901924908019823940835656341344740227"
        "0445462102068592377843";
    array[30] =
        "322455182461323223253768007794681866015683528877808734480537039781"
        "137973163167125485384682668227367787021477846223717136514039018377"
        "0226853329363961324241919";
    array[31] =
        "124866131284428854303808740439912850802549174883962849538151492513"
        "154126006345815390666630922976120406699780176235877528454096531672"
        "77021864132608";
    array[32] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005429";
    array[33] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005430";
    array[34] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005431";
    array[35] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005432";
    array[36] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005433";
    array[37] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005434";
    array[38] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005435";
    array[39] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005436";
    array[40] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005437";
    array[41] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005438";
    array[42] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005439";
    array[43] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005440";
    array[44] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005441";
    array[45] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005442";
    array[46] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005443";
    array[47] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005444";
    array[48] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005445";
    array[49] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005446";
    array[50] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005447";
    array[51] =
        "686479766013060971498190079908139321726943530014330540939446345918"
        "554318339765539424505774633321719753296399637136332111386476861244"
        "0380340372808892707005448";
    return;
  }
}
